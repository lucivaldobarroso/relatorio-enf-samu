<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Lucivaldo Oliveira Barroso">
  <meta name="description" content="Avaliação e simulador de provas de RCP com questões SBV e SAVC, correção automática e ranking de desempenho. Autor: Lucivaldo Oliveira Barroso.">
  <meta name="keywords" content="RCP, SBV, SAVC, avaliação, simulador, AHA, treinamento, Lucivaldo Oliveira Barroso">
  <meta name="robots" content="index, follow">
  <title>AVALIAÇÃO DE RCP</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef3f9; color: #223; margin: 0; padding: 20px; position: relative; overflow-x: hidden; }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 16% 20%, rgba(122, 201, 211, .35) 0%, rgba(122, 201, 211, 0) 42%),
        radial-gradient(circle at 85% 12%, rgba(196, 225, 185, .35) 0%, rgba(196, 225, 185, 0) 38%),
        url("./assets/img-samuredondo.png") center 42% / min(60vw, 560px) no-repeat;
      opacity: .22;
      z-index: -1;
      pointer-events: none;
    }
    .container { max-width: 1100px; margin: 0 auto; background: #fff; padding: 26px; border-radius: 14px; box-shadow: 0 10px 28px rgba(0,0,0,.1); }
    h1, h2, h3 { margin: 0; }
    h1 { text-align: center; color: #13294b; font-size: 52px; }
    .sub { text-align: center; color: #4f6282; margin: 10px 0 18px; font-size: 24px; }

    .hidden { display: none !important; }

    .card { border: 1px solid #c8d4e6; border-radius: 12px; padding: 14px; background: #f8fbff; }
    .title-chip { display: inline-block; margin-bottom: 10px; background: #dfe8f6; color: #17345d; padding: 6px 12px; border-radius: 999px; font-size: 13px; font-weight: 700; text-transform: uppercase; }
    .ranking-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 12px; }

    .grid-3 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .field { margin-bottom: 10px; min-width: 0; }
    .field label { display:block; margin-bottom: 5px; font-weight: 700; color: #2c4468; }
    .field input, .field select { width: 100%; max-width: 100%; padding: 10px 12px; border: 1px solid #b9c8dd; border-radius: 10px; font-size: 17px; background: #fff; min-width: 0; }

    .menu { display:flex; justify-content:center; gap:12px; margin: 16px 0 8px; flex-wrap: wrap; }
    .btn { padding: 12px 26px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 30px; color: #fff; transition: .2s; }
    .btn:hover { opacity: .9; transform: translateY(-1px); }
    .btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
    .btn-sbv { background: #1976d2; }
    .btn-savc { background: #d32f2f; }
    .btn-sec { background: #4f6282; font-size: 22px; padding: 12px 20px; }
    .home-actions { justify-content: center; align-items: center; flex-wrap: wrap; }
    .home-actions .btn { font-size: 20px; padding: 12px 18px; min-width: 230px; white-space: nowrap; }
    .choice-actions { justify-content: center; align-items: center; margin-top: 8px; }
    .choice-actions .btn { font-size: 18px; padding: 10px 18px; min-width: 240px; }
    .btn-choice { color: #17345d; box-shadow: inset 0 0 0 1px rgba(23, 52, 93, .16); }
    .btn-choice-novo { background: #f4c542; }
    .btn-choice-cadastrado { background: #57b66b; color: #fff; box-shadow: none; }
    .btn-choice.active { outline: 3px solid rgba(19, 41, 75, .24); outline-offset: 2px; }
    .helper-text { margin: 10px 0 0; color: #425979; font-size: 17px; line-height: 1.45; }
    .readonly-field { background: #eaf0f8 !important; }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #d9e4f2; padding: 8px 6px; text-align: left; font-size: 20px; }
    th { color: #2f4d75; }

    /* Tela da prova (estilo antigo) */
    #quiz-title { text-align:center; color:#b71c1c; margin: 0 0 14px; }
    .quiz-meta { text-align:center; margin: 0 0 14px; color: #1d3f67; font-weight: 700; }
    .question-block { margin-bottom: 22px; padding: 14px; border-left: 5px solid #ddd; background-color: #fafafa; border-radius: 4px; }
    .question-title { font-weight: bold; margin-bottom: 10px; font-size: 1.04em; }
    .options label { display: block; margin-bottom: 8px; cursor: pointer; padding: 8px; border-radius: 5px; transition: background .2s; }
    .options label:hover { background-color: #e0e0e0; }
    .correct { background-color: #c8e6c9 !important; border: 1px solid #4caf50; }
    .incorrect { background-color: #ffcdd2 !important; border: 1px solid #f44336; text-decoration: line-through; }
    .feedback { display: none; margin-top: 10px; padding: 10px; background-color: #e3f2fd; border-left: 4px solid #1976d2; font-size: .9em; }
    #submit-btn { width: 100%; background:#388e3c; padding: 14px; font-size: 17px; border:0; border-radius: 8px; color:#fff; font-weight:700; cursor:pointer; }
    #results { margin-top: 16px; padding: 18px; text-align: center; font-size: 22px; font-weight: 700; background: #fff3e0; display: none; border-radius: 8px; border: 2px solid #1976d2; }
    .timer-fab { position: fixed; top: 16px; right: 16px; z-index: 1000; background: #17345d; color: #fff; border-radius: 999px; padding: 10px 16px; font-weight: 700; box-shadow: 0 6px 20px rgba(0,0,0,.2); }
    .timer-fab.ready { background: #2e7d32; }
    .timer-fab.danger { background: #b71c1c; }
    .modal { position: fixed; inset: 0; z-index: 1200; display: grid; place-items: center; background: rgba(15, 26, 43, .52); }
    .modal-card { width: min(520px, calc(100% - 24px)); background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 10px 28px rgba(0,0,0,.24); }
    .modal-card h3 { margin-bottom: 10px; color: #13294b; }
    .modal-card p { margin: 0 0 14px; color: #2e3f59; font-size: 18px; line-height: 1.4; }
    .loading-overlay { position: fixed; inset: 0; z-index: 1300; display: grid; place-items: center; background: rgba(15, 26, 43, .45); }
    .loading-box { width: min(500px, calc(100% - 24px)); background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 10px 28px rgba(0,0,0,.24); text-align: center; }
    .loading-box h3 { color: #17345d; margin-bottom: 8px; }
    .loading-box p { color: #324867; margin: 0; font-size: 18px; }
    .site-footer { margin-top: 22px; padding-top: 18px; border-top: 2px solid #bdd0e8; text-align: center; color: #17345d; font-size: 16px; }
    .footer-brand { display: inline-flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #f2f8ff, #ffffff); border: 1px solid #b8cde6; border-radius: 999px; padding: 12px 18px; box-shadow: 0 8px 18px rgba(19, 41, 75, .12); font-weight: 700; }
    .footer-brand img { height: 40px; width: auto; object-fit: contain; }
    .dev-fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1100;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,.96);
      border: 1px solid #ccd8ea;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 8px 12px 8px 8px;
      text-decoration: none;
      color: #16345b;
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .04em;
      text-transform: uppercase;
      backdrop-filter: blur(4px);
    }
    .dev-fab .video-wrap {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #c4d1e5;
      background: #fff;
      flex: 0 0 auto;
    }
    .dev-fab video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .dev-fab:hover { transform: translateY(-1px); }

    @media (max-width: 980px) {
      h1 { font-size: 40px; }
      .sub { font-size: 20px; }
      .grid-3, .ranking-row { grid-template-columns: 1fr; }
      .btn { font-size: 24px; }
      .home-actions { flex-wrap: wrap; }
      .home-actions .btn, .choice-actions .btn { width: 100%; min-width: 0; }
      th, td { font-size: 16px; }
      .dev-fab { right: 10px; bottom: 10px; font-size: 11px; gap: 8px; padding-right: 10px; }
      .dev-fab .video-wrap { width: 36px; height: 36px; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- TELA INICIAL -->
  <section id="home-screen">
    <h1>AVALIAÇÃO DE RCP - 2026</h1>
    <p class="sub">Preencha seus dados, escolha a prova e responda 20 questões em até 20 minutos.</p>

    <div class="card">
      <span class="title-chip">Identificação do Aluno</span>

      <p class="helper-text">Escolha se o aluno vai fazer um novo cadastro ou se j&aacute; possui cadastro. Para novo cadastro, informe nome completo, profiss&atilde;o e CPF v&aacute;lido. Para aluno j&aacute; cadastrado, selecione o nome, confira a profiss&atilde;o e digite o CPF correspondente. As provas SBV e SAVC s&oacute; ser&atilde;o liberadas ap&oacute;s essa confirma&ccedil;&atilde;o.</p>

      <div class="menu choice-actions">
        <button id="btnNovoCadastro" class="btn btn-choice btn-choice-novo" type="button" onclick="setCadastroMode('novo')">NOVO CADASTRO</button>
        <button id="btnJaCadastrado" class="btn btn-choice btn-choice-cadastrado" type="button" onclick="setCadastroMode('cadastrado')">J&Aacute; SOU CADASTRADO</button>
      </div>

      <div id="novoCadastroFields" class="hidden">
        <div class="grid-3">
          <div class="field">
            <label>Nome completo</label>
            <input id="nome" placeholder="Digite nome e sobrenome" />
          </div>
          <div class="field">
            <label>Profissão</label>
            <select id="profissao">
              <option value="">Selecione a profissão</option>
              <option>ENFERMEIRO</option>
              <option>MEDICO</option>
              <option>TEC DE ENFERMAGEM</option>
              <option>CONDUTOR</option>
              <option>ESTUDANTE MEDICINA</option>
              <option>ESTUDANTE ENFERMAGEM</option>
              <option>OUTROS</option>
            </select>
          </div>
          <div class="field" id="fieldOutraProfissao">
            <label>Outra profissão</label>
            <input id="outraProfissao" placeholder="Digite a profissão" />
          </div>
        </div>

        <div class="field">
          <label>CPF</label>
          <input id="cpfNovo" placeholder="Digite um CPF válido" maxlength="14" />
        </div>
      </div>

      <div id="cadastradoFields" class="hidden">
        <div class="field">
          <label>Nome completo</label>
          <input id="alunoNomeBusca" list="alunoNomesList" placeholder="Selecione ou digite seu nome" autocomplete="off" />
          <datalist id="alunoNomesList"></datalist>
        </div>

        <div class="field">
          <label>Profissão</label>
          <input id="profissaoCadastrado" class="readonly-field" placeholder="A profissão aparecerá automaticamente" readonly />
        </div>

        <div class="field hidden" id="fieldCpfCadastrado">
          <label>CPF</label>
          <input id="cpfConfirmA" placeholder="Digite o CPF do cadastro" maxlength="14" />
        </div>
      </div>

      <div class="menu home-actions">
        <button id="btnStartSBV" class="btn btn-sbv" onclick="startQuiz('sbv')" disabled>Iniciar Prova SBV</button>
        <button id="btnStartSAVC" class="btn btn-savc" onclick="startQuiz('savc')" disabled>Iniciar Prova SAVC</button>
        <button class="btn btn-sec" onclick="refreshRanking()">Atualizar ranking</button>
      </div>

      <div id="status" style="margin-top:10px;color:#b71c1c;font-weight:700;"></div>
    </div>

    <div class="ranking-row">
      <div class="card">
        <span class="title-chip">Ranking SBV</span>
        <table>
          <thead><tr><th>#</th><th>Iniciais</th><th>Profissão</th><th>Nota</th></tr></thead>
          <tbody id="rankSBV"></tbody>
        </table>
      </div>

      <div class="card">
        <span class="title-chip">Ranking SAVC</span>
        <table>
          <thead><tr><th>#</th><th>Iniciais</th><th>Profissão</th><th>Nota</th></tr></thead>
          <tbody id="rankSAVC"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- TELA PROVA -->
  <section id="quiz-screen" class="hidden">
    <h2 id="quiz-title"></h2>
    <p id="quiz-meta" class="quiz-meta"></p>
    <div id="quiz-container"></div>
    <button id="submit-btn" onclick="submitQuiz()">Finalizar e Corrigir Prova</button>
    <div id="results"></div>
    <button class="btn btn-sec" style="margin-top:12px;" onclick="goHome()">Voltar ao início e perder esta prova</button>
  </section>

  <footer class="site-footer">
    <span class="footer-brand">
      <img src="./assets/logo-dev.png" alt="Logo da empresa LB Conexao Dev">
      <span>2026 Todos os Direitos Reservados Lucivaldo Oliveira Barroso.</span>
    </span>
  </footer>
</div>

<a class="dev-fab" href="./assets/logo-lb-conexao-dev-explosao.mp4" target="_blank" rel="noopener noreferrer" title="LB Conexao Dev">
  <span class="video-wrap">
    <video autoplay muted loop playsinline>
      <source src="./assets/logo-lb-conexao-dev-explosao.mp4" type="video/mp4">
    </video>
  </span>
  <span>Desenvolvido por LB Conexao Dev</span>
</a>

<button id="timerFab" class="timer-fab hidden" type="button">20:00</button>

<div id="timeoutModal" class="modal hidden">
  <div class="modal-card">
    <h3>Tempo encerrado</h3>
    <p>O tempo de prova foi finalizado. Sua avaliação foi corrigida automaticamente com base nas respostas já marcadas.</p>
    <button class="btn btn-sec" style="width:100%;" onclick="closeTimeoutModal()">OK</button>
  </div>
</div>

<div id="earlySubmitModal" class="modal hidden">
  <div class="modal-card">
    <h3>Tempo incompatível com a prova</h3>
    <p>Esse tempo é incompatível com a realização correta da avaliação e pode indicar que a prova não foi feita normalmente. Por isso, esta nota não será validada.</p>
    <p>Se desejar, você pode sair agora e voltar ao início. Ao sair, esta prova será perdida e nenhuma nota será registrada.</p>
    <div class="menu" style="margin-top:14px;">
      <button class="btn btn-sec" type="button" onclick="closeEarlySubmitModal()">Continuar prova</button>
      <button class="btn btn-savc" type="button" onclick="exitInvalidAttempt()">Sair sem validar nota</button>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-box">
    <h3>Aguarde um instante</h3>
    <p id="loadingText">Carregando dados e preparando sua prova...</p>
  </div>
</div>

<script src="./questoes-completas.js"></script>
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwXx-FiH6u50TPdYertjiHRZGdBHQbzUwNsoCGGHyqw381dnU-9Z4pi-tBgj4qgpXJOOw/exec";
  const LS_ALUNOS = "prova_pcr_alunos";
  const LS_TENTATIVAS = "prova_pcr_tentativas_por_prova";

  const QUESTIONS_PER_TEST = 20;
  const QUIZ_SECONDS = 20 * 60;
  const MIN_SUBMIT_SECONDS = 6 * 60;
  let currentQuestions = [];
  let currentTest = '';
  let currentAluno = null;
  let provaIniciadaEm = 0;
  let currentTentativa = 0;
  let quizLocked = false;
  let timerInterval = null;
  let timeLeftSeconds = QUIZ_SECONDS;
  let cadastroMode = '';

  function maskCpf(v){
    const d = String(v||'').replace(/\D/g,'').slice(0,11);
    return d.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');
  }
  function cpfNum(v){ return String(v||'').replace(/\D/g,''); }
  function upper(v){ return String(v||'').toUpperCase(); }
  function iniciais(nome){ return upper(nome).trim().split(/\s+/).filter(Boolean).map(p=>p[0]).join('').slice(0,4); }
  function isValidCpf(value){
    const cpf = cpfNum(value);
    if(cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let sum = 0;
    for(let i = 0; i < 9; i++) sum += Number(cpf[i]) * (10 - i);
    let digit = (sum * 10) % 11;
    if(digit === 10) digit = 0;
    if(digit !== Number(cpf[9])) return false;
    sum = 0;
    for(let i = 0; i < 10; i++) sum += Number(cpf[i]) * (11 - i);
    digit = (sum * 10) % 11;
    if(digit === 10) digit = 0;
    return digit === Number(cpf[10]);
  }

  function getArray(name){
    if (typeof globalThis !== 'undefined' && Array.isArray(globalThis[name])) return globalThis[name];
    try { const v = Function(`return (typeof ${name} !== 'undefined') ? ${name} : undefined;`)(); return Array.isArray(v)?v:[]; } catch { return []; }
  }
  function getBanco(type){
    if (type === 'sbv') return getArray('questoesSBV').concat(getArray('maisQuestoesSBV'));
    return getArray('questoesSAVC').concat(getArray('maisQuestoesSAVC'));
  }

  function sanitizeQuestionText(text){
    return String(text || '').replace(/^\s*\d+\s*[.)-]\s*/, '').trim();
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  function getAlunos(){ try { return JSON.parse(localStorage.getItem(LS_ALUNOS)||'[]'); } catch { return []; } }
  function setAlunos(v){ localStorage.setItem(LS_ALUNOS, JSON.stringify(v)); }
  function upsertAluno(a){ const arr=getAlunos(); const i=arr.findIndex(x=>x.cpf===a.cpf); if(i>=0) arr[i]=a; else arr.push(a); setAlunos(arr); }
  function upsertAlunosBatch(lista){
    // Espelha exatamente o banco: remove locais que não existem mais no Sheets
    setAlunos(lista);
  }
  function getTentativas(){ try { return JSON.parse(localStorage.getItem(LS_TENTATIVAS)||'{}'); } catch { return {}; } }
  function setTentativas(v){ localStorage.setItem(LS_TENTATIVAS, JSON.stringify(v)); }
  function tentativaKey(cpf, prova){ return `${cpf}_${prova}`; }
  function incTentativa(cpf, prova){
    const data = getTentativas();
    const key = tentativaKey(cpf, prova);
    data[key] = Number(data[key] || 0) + 1;
    setTentativas(data);
    return data[key];
  }

  function getAlunosUnicosPorNome(){
    const map = new Map();
    getAlunos()
      .slice()
      .sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'))
      .forEach(aluno => {
        const nome = upper(aluno.nome).trim();
        if(nome && !map.has(nome)) map.set(nome, { ...aluno, nome });
      });
    return [...map.values()];
  }

  function getAlunoByCpf(cpf){
    const normalizedCpf = cpfNum(cpf);
    if(!normalizedCpf) return null;
    return getAlunos().find(a => a.cpf === normalizedCpf) || null;
  }

  function fillAlunoSelect(){
    const input = document.getElementById('alunoNomeBusca');
    const list = document.getElementById('alunoNomesList');
    const atual = upper(input.value.trim());
    const alunos = getAlunosUnicosPorNome();
    list.innerHTML = alunos.map(a=>`<option value="${a.nome}"></option>`).join('');
    if(atual && !alunos.some(a => a.nome === atual)){
      input.value = '';
    }
  }

  function getAlunoSelecionadoPorNome(){
    const nome = upper(document.getElementById('alunoNomeBusca').value.trim());
    if(!nome) return null;
    return getAlunosUnicosPorNome().find(a => a.nome === nome) || null;
  }

  function onAlunoChange(){
    const aluno = getAlunoSelecionadoPorNome();
    const profInput = document.getElementById('profissaoCadastrado');
    const cpfField = document.getElementById('fieldCpfCadastrado');
    if(aluno){
      profInput.value = aluno.profissao;
      cpfField.classList.remove('hidden');
    } else {
      profInput.value = '';
      cpfField.classList.add('hidden');
      document.getElementById('cpfConfirmA').value = '';
    }
    updateStartButtons();
  }

  function onProfissaoChange(){
    const outros = document.getElementById('profissao').value === 'OUTROS';
    document.getElementById('fieldOutraProfissao').style.display = outros ? 'block' : 'none';
    if(!outros) document.getElementById('outraProfissao').value = '';
    updateStartButtons();
  }

  function setCadastroMode(mode){
    cadastroMode = mode;
    document.getElementById('btnNovoCadastro').classList.toggle('active', mode === 'novo');
    document.getElementById('btnJaCadastrado').classList.toggle('active', mode === 'cadastrado');
    document.getElementById('novoCadastroFields').classList.toggle('hidden', mode !== 'novo');
    document.getElementById('cadastradoFields').classList.toggle('hidden', mode !== 'cadastrado');
    document.getElementById('status').textContent = '';

    if(mode === 'novo'){
      document.getElementById('alunoNomeBusca').value = '';
      document.getElementById('profissaoCadastrado').value = '';
      document.getElementById('cpfConfirmA').value = '';
      document.getElementById('fieldCpfCadastrado').classList.add('hidden');
    } else if(mode === 'cadastrado'){
      document.getElementById('nome').value = '';
      document.getElementById('profissao').value = '';
      document.getElementById('outraProfissao').value = '';
      document.getElementById('cpfNovo').value = '';
      onProfissaoChange();
    }
    updateStartButtons();
  }

  function parseRankingDate(value){
    const raw = String(value || '').trim();
    if(!raw) return NaN;

    const direct = Date.parse(raw);
    if(!Number.isNaN(direct)) return direct;

    const normalized = raw.replace(/\s+/, ' ').replace(' ', 'T');
    const normalizedTime = Date.parse(normalized);
    if(!Number.isNaN(normalizedTime)) return normalizedTime;

    const match = raw.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:[ T](\d{1,2})(?::(\d{1,2}))?(?::(\d{1,2}))?)?$/);
    if(match){
      const [, dd, mm, yyyy, hh = '0', mi = '0', ss = '0'] = match;
      const year = yyyy.length === 2 ? `20${yyyy}` : yyyy;
      return new Date(
        Number(year),
        Number(mm) - 1,
        Number(dd),
        Number(hh),
        Number(mi),
        Number(ss)
      ).getTime();
    }

    return NaN;
  }

  function getRankingTimestamp(row){
    const combinedDateTime = [
      row.data_hora_registro,
      row.dataHoraRegistro,
      row.data_hora,
      row.dataHora,
      row.registrado_em,
      row.registradoEm,
      row.created_at,
      row.createdAt,
      row.timestamp,
      row.datetime,
      row.data_registro,
      row.dataRegistro,
      row.submitted_at,
      row.enviado_em
    ];

    for(const value of combinedDateTime){
      const parsed = parseRankingDate(value);
      if(!Number.isNaN(parsed)) return parsed;
    }

    const datePart = row.data || row.data_nota || row.dataRegistroNota || row.data_registro || '';
    const timePart = row.hora || row.hora_registro || row.horaRegistro || row.horario || '';
    const parsedCombined = parseRankingDate(`${datePart} ${timePart}`.trim());
    if(!Number.isNaN(parsedCombined)) return parsedCombined;

    return Number.MAX_SAFE_INTEGER;
  }

  function resolveRankingProfissao(row){
    if(row.profissao && String(row.profissao).trim()) return upper(String(row.profissao).trim());
    const aluno = getAlunoByCpf(row.cpf);
    if(aluno && aluno.profissao) return aluno.profissao;
    return 'OUTROS';
  }

  function normalizeRanking(rows){
    return rows
      .map((row, originalIndex) => ({ ...row, __originalIndex: originalIndex }))
      .sort((a, b) => {
        const notaDiff = Number(b.nota || 0) - Number(a.nota || 0);
        if(notaDiff !== 0) return notaDiff;
        const timeDiff = getRankingTimestamp(a) - getRankingTimestamp(b);
        if(timeDiff !== 0) return timeDiff;
        return a.__originalIndex - b.__originalIndex;
      })
      .map((row, index) => {
        const { __originalIndex, ...cleanRow } = row;
        return { ...cleanRow, profissao: resolveRankingProfissao(cleanRow), posicao: index + 1 };
      });
  }

  function updateStartButtons(){
    const aluno = validateAluno(true);
    const disabled = !aluno;
    const status = document.getElementById('status');
    document.getElementById('btnStartSBV').disabled = disabled;
    document.getElementById('btnStartSAVC').disabled = disabled;
    if(aluno){
      status.textContent = '';
      return;
    }

    if(cadastroMode === 'cadastrado'){
      const alunoSelecionado = getAlunoSelecionadoPorNome();
      const cpfDigitado = cpfNum(document.getElementById('cpfConfirmA').value);
      if(alunoSelecionado && cpfDigitado.length === 11){
        validateAluno(false);
        return;
      }
    }

    if(cadastroMode === 'novo'){
      const cpfNovo = cpfNum(document.getElementById('cpfNovo').value);
      if(cpfNovo.length === 11){
        validateAluno(false);
        return;
      }
    }

    status.textContent = '';
  }

  async function apiPostForm(payload){
    const body = new URLSearchParams();
    Object.entries(payload).forEach(([k, v]) => body.append(k, String(v ?? '')));

    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body
    });

    const text = await resp.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}
    if (!resp.ok) throw new Error(`Falha HTTP ${resp.status}`);
    if (!data || data.ok !== true) throw new Error((data && data.error) ? data.error : 'Resposta inválida do servidor');
    return data;
  }

  async function refreshRanking(){
    const setRows = (id, rows) => {
      const tb = document.getElementById(id);
      const normalized = normalizeRanking(rows);
      if(!normalized.length){ tb.innerHTML = '<tr><td colspan="4">Sem registros ainda.</td></tr>'; return; }
      tb.innerHTML = normalized.map(r=>`<tr><td>${r.posicao}</td><td>${r.iniciais || ''}</td><td>${r.profissao || 'OUTROS'}</td><td>${Number(r.nota).toFixed(2)}</td></tr>`).join('');
    };

    try {
      const [sbvRes, savcRes] = await Promise.all([
        fetch(`${API_URL}?action=ranking&prova=sbv&limit=500`).then(r=>r.json()),
        fetch(`${API_URL}?action=ranking&prova=savc&limit=500`).then(r=>r.json())
      ]);
      setRows('rankSBV', sbvRes.ok ? (Array.isArray(sbvRes.ranking) ? sbvRes.ranking : (sbvRes.data || [])) : []);
      setRows('rankSAVC', savcRes.ok ? (Array.isArray(savcRes.ranking) ? savcRes.ranking : (savcRes.data || [])) : []);
      await syncAlunosFromApi();
    } catch {
      setRows('rankSBV', []); setRows('rankSAVC', []);
    }
  }

  async function syncAlunosFromApi(){
    const actions = ['list_alunos', 'alunos', 'listar_alunos'];
    for (const action of actions) {
      try {
        const resp = await fetch(`${API_URL}?action=${action}&limit=1000`);
        const text = await resp.text();
        let data = null;
        try { data = JSON.parse(text); } catch {}
        if (!resp.ok || !data || data.ok !== true) continue;

        const listaBase = Array.isArray(data.alunos) ? data.alunos : (Array.isArray(data.data) ? data.data : []);
        if (!listaBase.length) continue;

        const lista = listaBase
          .map(item => ({
            cpf: cpfNum(item.cpf),
            nome: upper(String(item.nome || '').trim()),
            profissao: upper(String(item.profissao || '').trim() || 'OUTROS')
          }))
          .filter(item => item.cpf.length === 11 && item.nome);

        if (lista.length) {
          upsertAlunosBatch(lista);
          fillAlunoSelect();
          onAlunoChange();
          return;
        }
      } catch {}
    }
  }

  function showLoading(msg){
    document.getElementById('loadingText').textContent = msg || 'Carregando dados e preparando sua prova...';
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }

  function hideLoading(){
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  function formatClock(totalSec){
    const m = String(Math.floor(totalSec / 60)).padStart(2, '0');
    const s = String(totalSec % 60).padStart(2, '0');
    return `${m}:${s}`;
  }

  function updateTimerFab(){
    const el = document.getElementById('timerFab');
    const elapsedSeconds = QUIZ_SECONDS - Math.max(0, timeLeftSeconds);
    el.textContent = formatClock(Math.max(0, timeLeftSeconds));
    el.classList.toggle('ready', elapsedSeconds >= MIN_SUBMIT_SECONDS && timeLeftSeconds > 300);
    el.classList.toggle('danger', timeLeftSeconds <= 300);
  }

  function stopTimer(){
    if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
  }

  function hideTimer(){
    const el = document.getElementById('timerFab');
    el.classList.add('hidden');
    stopTimer();
  }

  function startTimer(){
    const el = document.getElementById('timerFab');
    timeLeftSeconds = QUIZ_SECONDS;
    updateTimerFab();
    el.classList.remove('hidden');
    stopTimer();
    timerInterval = setInterval(async () => {
      if (quizLocked) { stopTimer(); return; }
      timeLeftSeconds -= 1;
      updateTimerFab();
      if (timeLeftSeconds <= 0) {
        stopTimer();
        await submitQuiz(true);
      }
    }, 1000);
  }

  function openTimeoutModal(){
    document.getElementById('timeoutModal').classList.remove('hidden');
  }

  function closeTimeoutModal(){
    document.getElementById('timeoutModal').classList.add('hidden');
  }

  function openEarlySubmitModal(){
    document.getElementById('earlySubmitModal').classList.remove('hidden');
  }

  function closeEarlySubmitModal(){
    document.getElementById('earlySubmitModal').classList.add('hidden');
  }

  function exitInvalidAttempt(){
    closeEarlySubmitModal();
    goHome();
  }

  function validateAluno(silent = false){
    const status = document.getElementById('status');
    if(!silent) status.textContent = '';
    const setError = (message) => {
      if(!silent) status.textContent = message;
      return null;
    };

    if(!cadastroMode) return setError('Escolha NOVO CADASTRO ou JÁ SOU CADASTRADO.');

    if(cadastroMode === 'novo'){
      const nome = upper(document.getElementById('nome').value.trim());
      const profSel = document.getElementById('profissao').value;
      const prof = profSel === 'OUTROS' ? upper(document.getElementById('outraProfissao').value.trim()) : profSel;
      const cpf = cpfNum(document.getElementById('cpfNovo').value);

      if(!nome || !prof) return setError('Preencha nome e profissão.');
      if(!cpf) return setError('Digite o CPF do novo cadastro.');
      if(!isValidCpf(cpf)) return setError('Digite um CPF válido para liberar as provas.');

      const aluno = { nome, profissao: prof, cpf };
      if(!silent) upsertAluno(aluno);
      fillAlunoSelect();
      return aluno;
    }

    const aluno = getAlunoSelecionadoPorNome();
    const cpfA = cpfNum(document.getElementById('cpfConfirmA').value);
    if(!aluno) return setError('Selecione seu nome na lista de cadastrados.');
    if(!cpfA) return setError('Digite o CPF do cadastro para validação.');
    if(!isValidCpf(cpfA)) return setError('Digite um CPF válido para continuar.');
    if(cpfA !== aluno.cpf) return setError('O CPF digitado não confere com o cadastro do banco de dados para este aluno. Verifique os dados informados.');
    return aluno;
  }

  async function startQuiz(type){
    const aluno = validateAluno();
    if(!aluno) return;
    const status = document.getElementById('status');
    showLoading('Carregando dados do aluno e iniciando a prova...');

    try {
      await apiPostForm({
        action: 'upsert_aluno',
        cpf: aluno.cpf,
        nome: aluno.nome,
        iniciais: iniciais(aluno.nome),
        profissao: aluno.profissao
      });
      status.textContent = '';
    } catch (err) {
      status.textContent = `Falha ao salvar aluno no banco: ${err.message}`;
      hideLoading();
      return;
    }

    const banco = getBanco(type);
    if(!banco.length){ document.getElementById('status').textContent='Banco de questões não encontrado.'; hideLoading(); return; }

    currentAluno = aluno;
    currentTest = type;
    provaIniciadaEm = Date.now();
    currentTentativa = incTentativa(aluno.cpf, type);
    quizLocked = false;
    currentQuestions = shuffle(banco).slice(0, Math.min(QUESTIONS_PER_TEST, banco.length));

    document.getElementById('home-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    closeTimeoutModal();
    closeEarlySubmitModal();

    document.getElementById('quiz-title').innerText = type === 'sbv'
      ? `Prova de Suporte Básico de Vida (SBV) - ${aluno.nome}`
      : `Prova de Suporte Avançado de Vida (SAVC) - ${aluno.nome}`;
    document.getElementById('quiz-meta').textContent = `ALUNO: ${aluno.nome} | PROFISSÃO: ${aluno.profissao} | TENTATIVA ${type.toUpperCase()}: ${currentTentativa}`;

    document.getElementById('results').style.display = 'none';
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('submit-btn').textContent = 'Finalizar e Corrigir Prova';

    let html = '';
    currentQuestions.forEach((q, index) => {
      html += `<div class="question-block" id="qblock-${index}">`;
      html += `<div class="question-title">${sanitizeQuestionText(q.q)}</div>`;
      html += `<div class="options">`;
      q.o.forEach((opt, optIndex) => {
        html += `<label><input type="radio" name="q${index}" value="${optIndex}"> ${opt}</label>`;
      });
      html += `</div>`;
      html += `<div class="feedback" id="feed-${index}">${q.f || ''}</div>`;
      html += `</div>`;
    });
    document.getElementById('quiz-container').innerHTML = html;
    startTimer();
    hideLoading();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function submitQuiz(forceByTimer = false){
    if(!currentQuestions.length){ alert('Escolha uma prova primeiro.'); return; }
    if(quizLocked){ return; }
    const elapsedSeconds = Math.max(0, Math.floor((Date.now() - provaIniciadaEm) / 1000));
    if(!forceByTimer && elapsedSeconds < MIN_SUBMIT_SECONDS){
      openEarlySubmitModal();
      return;
    }
    if(!forceByTimer){
      const unanswered = currentQuestions.findIndex((_, index) => !document.querySelector(`input[name="q${index}"]:checked`));
      if(unanswered !== -1){
        alert('Todas as questões são obrigatórias. Responda toda a prova antes de finalizar.');
        const block = document.getElementById(`qblock-${unanswered}`);
        if(block) block.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
    }
    quizLocked = true;
    stopTimer();

    let score = 0;
    const total = currentQuestions.length;

    currentQuestions.forEach((q, index) => {
      const block = document.getElementById(`qblock-${index}`);
      const selected = document.querySelector(`input[name="q${index}"]:checked`);
      const feedback = document.getElementById(`feed-${index}`);
      const labels = block.querySelectorAll('label');
      labels.forEach(l => l.className = '');

      if(selected){
        const selectedVal = Number(selected.value);
        const selectedLabel = selected.parentElement;
        if(selectedVal === q.a){ score++; selectedLabel.classList.add('correct'); }
        else { selectedLabel.classList.add('incorrect'); if(labels[q.a]) labels[q.a].classList.add('correct'); }
      } else {
        if(labels[q.a]) labels[q.a].classList.add('correct');
      }
      feedback.style.display = 'block';
    });
    document.querySelectorAll('#quiz-container input[type="radio"]').forEach(input => { input.disabled = true; });
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').textContent = 'Prova finalizada';

    const percentage = ((score/total)*100).toFixed(0);
    const p = Number(percentage);
    let msg = '';
    if (p < 40) {
      msg = 'Reprovado. É necessário revisar as Diretrizes de RCP e retomar os principais algoritmos.';
    } else if (p <= 60) {
      msg = 'Você precisa melhorar. Revise os pontos críticos e pratique novamente.';
    } else if (p <= 80) {
      msg = 'Você está no caminho certo. Continue estudando para consolidar os protocolos.';
    } else {
      msg = 'Muito bem! Excelente desempenho e boa aderência às Diretrizes de RCP.';
    }

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = `Sua pontuação: ${score} de ${total} (${percentage}%)<br><span style="font-size:18px;">${msg}</span>`;
    resultsDiv.style.display = 'block';

    if (currentAluno) {
      const tempoSeg = Math.max(1, Math.floor((Date.now() - provaIniciadaEm) / 1000));
      const nota = Number(((score / total) * 100).toFixed(2));
      try {
        await apiPostForm({
          action: 'salvar_tentativa',
          cpf: currentAluno.cpf,
          nome: currentAluno.nome,
          iniciais: iniciais(currentAluno.nome),
          profissao: currentAluno.profissao,
          prova: currentTest,
          acertos: score,
          total: total,
          nota: nota,
          tempo_seg: tempoSeg
        });
        resultsDiv.innerHTML += `<br><span style="font-size:16px;color:#1b5e20;">Resultado salvo no banco de dados.</span>`;
      } catch (err) {
        resultsDiv.innerHTML += `<br><span style="font-size:16px;color:#b71c1c;">Falha ao salvar no banco: ${err.message}</span>`;
      }
    }
    if (forceByTimer) {
      openTimeoutModal();
    }

    window.scrollTo({ top: resultsDiv.offsetTop - 40, behavior: 'smooth' });
  }

  function goHome(){
    document.getElementById('quiz-screen').classList.add('hidden');
    document.getElementById('home-screen').classList.remove('hidden');
    document.getElementById('quiz-container').innerHTML = '';
    currentQuestions = [];
    currentAluno = null;
    provaIniciadaEm = 0;
    currentTentativa = 0;
    quizLocked = false;
    hideTimer();
    closeTimeoutModal();
    closeEarlySubmitModal();
    refreshRanking();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  (async function boot(){
    fillAlunoSelect();
    onProfissaoChange();
    await syncAlunosFromApi();
    refreshRanking();
    hideTimer();
    closeTimeoutModal();
    closeEarlySubmitModal();
    hideLoading();

    ['cpfConfirmA','cpfNovo'].forEach(id=>{
      document.getElementById(id).addEventListener('input', e=>e.target.value = maskCpf(e.target.value));
    });
    ['nome','outraProfissao'].forEach(id=>{
      document.getElementById(id).addEventListener('input', e=>{
        e.target.value = upper(e.target.value);
        updateStartButtons();
      });
    });

    ['cpfConfirmA','cpfNovo'].forEach(id=>{
      document.getElementById(id).addEventListener('input', updateStartButtons);
    });
    document.getElementById('alunoNomeBusca').addEventListener('input', e=>{
      e.target.value = upper(e.target.value);
      onAlunoChange();
    });
    document.getElementById('alunoNomeBusca').addEventListener('change', onAlunoChange);
    document.getElementById('profissao').addEventListener('change', onProfissaoChange);
    updateStartButtons();
  })();
</script>
</body>
</html>
