<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CME SAMU 192 | Boa Vista</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --samu-blue: #0d47a1; --samu-red: #d32f2f; }
        body { background: #f4f7f6; font-size: 0.85rem; }
        .header { background: var(--samu-blue); color: white; border-bottom: 5px solid var(--samu-red); padding: 15px 0; }
        #main-app, .loader { display: none; }
        .card-pedido { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 20px; border-left: 5px solid var(--samu-red); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        
        /* Ajustes para Mobile */
        @media (max-width: 768px) {
            .header h5 { font-size: 0.9rem; text-align: center; margin-bottom: 5px; }
            .header .container { flex-direction: column; text-align: center; }
            #user-display { text-align: center !important; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .card-pedido { padding: 10px; }
            .btn-sm { padding: 0.5rem; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div id="loading" class="overlay">
    <div class="spinner-border text-danger"></div>
    <h6 class="mt-2 fw-bold">Aguarde, processando...</h6>
</div>

<div id="login-page" class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-4 card p-4 shadow-sm border-0">
            <h4 class="text-center fw-bold text-primary mb-4">SAMU 192 BOA VISTA<br>CENTRAL DE MATERIAL ESTERELIZADO</h4>
            <label class="fw-bold small">Primeiro Nome</label>
            <input type="text" id="ipt_u" class="form-control mb-2" placeholder="Ex: Joao">
            <label class="fw-bold small">CPF (Senha)</label>
            <input type="password" id="ipt_p" class="form-control mb-3" placeholder="Apenas números">
            <button onclick="fazerLogin()" class="btn btn-danger w-100 fw-bold py-2">ENTRAR</button>
        </div>
    </div>
</div>

<div id="main-app">
    <div class="header shadow-sm mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">CME | SAMU 192 BOA VISTA | PEDIDO DE MATERIAL</h5>
            <div id="user-display" class="text-white text-end fw-bold small"></div>
        </div>
    </div>

    <div class="container">
        <div id="secoes-container" class="table-responsive"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykhb149ePKJM3VfqlwHQMdjXQnCeYy8jD-sS35_Lun28B6MT6gs-2-vH7OXRNldQHf0w/exec";

    let USER = null; 
    let LISTAS = null; 
    let CARRINHOS = { CONTROLADO: [], MEDICAMENTO: [], MATERIALH: [] };

    async function api(dados) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(dados) });
            const json = await res.json();
            return json;
        } catch (e) {
            Swal.fire('Erro de Conexão', 'Verifique a URL do Script e permissões.', 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function fazerLogin() {
        const user = document.getElementById('ipt_u').value;
        const pass = document.getElementById('ipt_p').value;
        const res = await api({ acao: 'login', user, pass });

        if(res && res.success) {
            USER = res;
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-display').innerHTML = `
                ${res.nomeCompleto}<br>
                Matrícula: ${res.matricula} | Função: ${res.funcao}
            `;
            LISTAS = await api({ acao: 'getListas' });
            renderizarSecoes();
        } else {
            Swal.fire('Erro', res ? res.msg : 'Falha no servidor', 'error');
        }
    }

    function renderizarSecoes() {
        const tipos = [
            { id: 'CONTROLADO', label: '1. MEDICAMENTOS CONTROLADOS', color: 'danger', itens: LISTAS.controlados },
            { id: 'MEDICAMENTO', label: '2. MEDICAMENTOS GERAIS', color: 'primary', itens: LISTAS.medicamentos },
            { id: 'MATERIALH', label: '3. MATERIAL MÉDICO-HOSPITALAR', color: 'success', itens: LISTAS.materialH }
        ];

        document.getElementById('secoes-container').innerHTML = tipos.map(t => `
            <div class="card-pedido">
                <h6 class="fw-bold text-${t.color}">${t.label}</h6>
                <div class="row g-2 mb-3">
                    <div class="col-md-4">
                        <select id="sel_${t.id}" class="form-select form-select-sm">
                            <option value="">Selecione o Item...</option>
                            ${t.itens.map(i => `<option value="${i}">${i}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="ap_${t.id}" class="form-select form-select-sm">
                            <option value="">Apresentação...</option>
                            ${LISTAS.apresentacao.map(a => `<option value="${a}">${a}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="q_${t.id}" class="form-control form-control-sm" placeholder="Qtd" value="1">
                    </div>
                    <div class="col-md-3">
                        <button onclick="addItem('${t.id}')" class="btn btn-outline-${t.color} btn-sm w-100 fw-bold">ADICIONAR</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-3">
                        <thead class="table-light">
                            <tr class="small"><th>Item</th><th>Apres.</th><th style="width:70px">Qtd</th><th>Obs do Item</th><th class="text-center">X</th></tr>
                        </thead>
                        <tbody id="cart_${t.id}"></tbody>
                    </table>
                </div>
                <button onclick="enviarPedido('${t.id}')" id="btn_${t.id}" class="btn btn-${t.color} w-100 fw-bold" disabled>GERAR PEDIDO ${t.id}</button>
            </div>
        `).join('');
    }

    function addItem(tipo) {
        const espec = document.getElementById(`sel_${tipo}`).value;
        const apres = document.getElementById(`ap_${tipo}`).value;
        const qtd = document.getElementById(`q_${tipo}`).value;

        if(!espec || !apres || qtd < 1) return Swal.fire('Aviso', 'Selecione Item, Apresentação e Qtd.', 'warning');

        CARRINHOS[tipo].push({ especificacao: espec, apresentacao: apres, quantidade: qtd, observacao: "" });
        
        document.getElementById(`sel_${tipo}`).value = "";
        document.getElementById(`ap_${tipo}`).value = "";
        document.getElementById(`q_${tipo}`).value = "1";
        
        renderTabela(tipo);
    }

    function renderTabela(tipo) {
        const corpo = document.getElementById(`cart_${tipo}`);
        corpo.innerHTML = CARRINHOS[tipo].map((it, idx) => `
            <tr>
                <td class="small">${it.especificacao}</td>
                <td class="small">${it.apresentacao}</td>
                <td><input type="number" class="form-control form-control-sm" value="${it.quantidade}" onchange="CARRINHOS['${tipo}'][${idx}].quantidade=this.value"></td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Obs..." onchange="CARRINHOS['${tipo}'][${idx}].observacao=this.value"></td>
                <td class="text-center"><button class="btn btn-sm btn-link text-danger p-0" onclick="CARRINHOS['${tipo}'].splice(${idx},1);renderTabela('${tipo}')">Remover</button></td>
            </tr>
        `).join('');
        document.getElementById(`btn_${tipo}`).disabled = CARRINHOS[tipo].length === 0;
    }

    async function enviarPedido(tipo) {
        const res = await api({ acao: 'pedido', userObj: USER, itens: CARRINHOS[tipo], tipoPedido: tipo });
        if(res && res.success) {
            Swal.fire({
                title: 'Sucesso!',
                html: `Pedido de ${tipo} enviado.<br><a href="${res.url}" target="_blank" class="btn btn-danger btn-sm mt-3 fw-bold">BAIXAR PDF</a>`,
                icon: 'success'
            });
            CARRINHOS[tipo] = [];
            renderTabela(tipo);
        } else {
            Swal.fire('Erro', 'Falha ao processar pedido.', 'error');
        }
    }
</script>
</body>
</html>
